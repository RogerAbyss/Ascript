fastlane_version "2.43.0"
default_platform :ios

platform :ios do

	before_all do
	end

	desc '仅用于测试'
	lane :devolop_env do |options|
	end

	desc '测试版,上传Fir'
	lane :test do |options|
		test_do(options)
	end

	desc '预发布,上传Fir'
	lane :beta do |options|
		beta_do(options)
	end

	desc '检查工程(依赖、证书等)'
	lane :refresh do |options|
		refresh_do(options)
	end

	desc '正式版,上传Apptore'
	lane :release do |options|
		release_do(options)
  	end

	desc '管理员调整工程(依赖、证书等)'
	lane :setting do |options|
		setting_do(options)
	end

	desc '配置Xcode插件(需要破解xcode)'
	lane :plugin do |options|
		plugin_do(options)
	end

	after_all do
	end

	####################################################################################################
	# Normal (For Jenkins)
	####################################################################################################

	private_lane :test_normal do |options|

		scheme				= options[:scheme]
		outputPath		 	= options[:out]
		projectPath			= options[:project]
		fir_token			= options[:fir_token]

		output_name 		= "#{scheme}_#{Time.now.strftime('%H%M')}.ipa"
		plist_drectory      = "#{projectPath}/#{scheme}/info.plist"
		tmp				 	= "#{projectPath}/fastlane/tmp"
		workspace		    = "#{projectPath}/#{scheme}.xcworkspace"

   	 	increment_build_number
   	 	increment_version_number

   	 	outputPath_real 	= outputPath + "/test"
   	 	gym(
   	 		workspace: workspace,
   	 		scheme: scheme, 
   	 		clean: true, 
   	 		output_directory: outputPath_real,
   	 		output_name: output_name, 
   	 		export_method: 'ad-hoc',
   	 		configuration: "Debug"
   	 		)

   	 	msg = "[自动上传v2.0],debug模式"
   	 	system "fir publish #{outputPath_real}/#{output_name} -T #{fir_token} -c #{msg}"
	end


	private_lane :beta_normal do |options|

		scheme				= options[:scheme]
		outputPath		 	= options[:out]
		projectPath			= options[:project]
		fir_token			= options[:fir_token]

		output_name 		= "#{scheme}_#{Time.now.strftime('%H%M')}.ipa"
		plist_drectory      = "#{projectPath}/#{scheme}/info.plist"
		tmp				 	= "#{projectPath}/fastlane/tmp"
		workspace		    = "#{projectPath}/#{scheme}.xcworkspace"

   	 	increment_build_number
   	 	increment_version_number

   	 	outputPath_real 	= outputPath + "/beta"
   	 	gym(
   	 		workspace: workspace,
   	 		scheme: scheme, 
   	 		clean: true, 
   	 		output_directory: outputPath_real,
   	 		output_name: output_name, 
   	 		export_method: 'ad-hoc',
   	 		configuration: "Release"
   	 		)

   	 	msg = "[自动上传v2.0],beta模式"
   	 	system "fir publish #{outputPath_real}/#{output_name} -T #{fir_token} -c #{msg}"
	end

	private_lane :release_normal do |options|

		scheme				= options[:scheme]
		outputPath		 	= options[:out]
		projectPath			= options[:project]

		output_name 		= "#{scheme}_#{Time.now.strftime('%H%M')}.ipa"
		plist_drectory      = "#{projectPath}/#{scheme}/info.plist"
		tmp				 	= "#{projectPath}/fastlane/tmp"
		workspace		    = "#{projectPath}/#{scheme}.xcworkspace"
		
   	 	increment_build_number
   	 	increment_version_number

   	 	outputPath_real		= outputPath + "/release"
   	 	gym(
   	 		workspace: workspace,
   	 		scheme: scheme, 
   	 		clean: true, 
   	 		output_directory: outputPath_real,
   	 		output_name: output_name, 
   	 		export_method: 'app-store',
   	 		configuration: "Release"
   	 		)

   	 	deliver(force: false, skip_metadata: true, skip_screenshots: true)
	end

	####################################################################################################
	# Ascript Support
	# Ascript的 lane在原有基础上有新加的参数
	####################################################################################################

	private_lane :test_do do |options|

		git_pull
		pod_update

		test_normal(options)
   	 	email(mode:"debug",scheme:scheme)

   	 	git_add(path: '.')
    	git_commit(path: '.', message: "自动发布 自动增长了版本号")
	end


	private_lane :beta_do do |options|

		git_pull
		pod_update

		beta_normal(options)
   	 	email(mode:"beta",scheme:scheme)

   	 	git_add(path: '.')
    	git_commit(path: '.', message: "自动发布 自动增长了版本号")
	end

	private_lane :release_do do |options|

		pod_update

		release_normal(options)
   	 	email(mode:"release",scheme:scheme)

   	 	git_add(path: '.')
    	git_commit(path: '.', message: "自动发布 自动增长了版本号")
	end

	private_lane :refresh_do do |options|

		matchUrl = options[:matchUrl]

		match(
			type: "appstore",
			git_url: matchUrl,
			readonly: true,
		)
		match(
			type: "adhoc",
			git_url: matchUrl,
			readonly: true,
		)
		match(
			type: "development",
			git_url: matchUrl,
			readonly: true,
		)
	end

	private_lane :setting_do do |options|

		matchUrl = options[:matchUrl]
		idendifiers	= options[:idendifiers]

		git_pull
		cocoapods

		match(
			type:"appstore",
			git_url:matchUrl,
			force_for_new_devices: true,
			app_identifier:idendifiers,
		)
		match(
			type:"adhoc",
			git_url:matchUrl,
			force_for_new_devices: true,
			app_identifier:idendifiers,
		)
		match(
			type:"development",
			git_url:matchUrl,
			force_for_new_devices: true,
			app_identifier:idendifiers,
		)
	end
	####################################################################################################
	# Ascript Addition
	# 不是必要的,一些小玩意
	####################################################################################################

	private_lane :plugin_do do |options|

		plugins		= options[:plugins]

		for plugin in plugins
			puts "I will install plugin from github:${plugin}"
			install_xcode_plugin(github:plugin)
		end
		
	end

end

platform :android do
end